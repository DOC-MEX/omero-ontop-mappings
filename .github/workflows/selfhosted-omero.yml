name: OMERO test-infra + Ontop + pytest

on:
  push:
  pull_request:

jobs:
  omero_ontop_pytest:
    runs-on: [self-hosted, Linux, X64, evolomero]

    env:
      OMERO_HOST: 127.0.0.1
      OMERO_PORT: "14064"
      OMERO_USER: root
      OMERO_PASS: omero

      # Postgres service exposed by docker-compose.override.yml
      PGHOST: 127.0.0.1
      PGPORT: "15432"

      OMERO_DB: postgres
      
      PGDATABASE: postgres
      PGUSER: ontop
      PGPASSWORD: "!ontop$"

    steps:
      - uses: actions/checkout@v4

      - name: Show runner info
        run: |
          set -euo pipefail
          whoami
          pwd
          uname -a
          docker --version
          docker compose version || true

      # ---------------------------------------------------------------------
      # omero-test-infra + port override 
      # ---------------------------------------------------------------------
      - name: Checkout omero-test-infra + add port override + mount repo
        run: |
          set -euo pipefail
          rm -rf .omero
          git clone --depth 1 https://github.com/ome/omero-test-infra .omero

          cat > .omero/docker-compose.override.yml <<'YAML'
          services:
            db:
              ports:
                - "15432:5432"
            omero:
              ports:
                - "14063:4063"
                - "14064:4064"
              volumes:
                - ..:/repo:ro
            web:
              ports:
                - "14080:4080"
          YAML

          echo "=== override ==="
          cat .omero/docker-compose.override.yml

      - name: Start OMERO test-infra stack
        run: |
          set -euo pipefail
          cd .omero
          docker compose up -d

      - name: Compose ps + logs for debugging
        run: |
          set -euo pipefail
          cd .omero
          docker compose ps
          docker compose logs --no-color --tail=120 db || true
          docker compose logs --no-color --tail=200 omero || true

      # ---------------------------------------------------------------------
      # Wait for Postgres 
      # ---------------------------------------------------------------------
      - name: Wait for Postgres to be ready
        run: |
          set -euo pipefail
          cd .omero
          for i in $(seq 1 120); do
            if docker compose exec -T db pg_isready -U postgres -d postgres >/dev/null 2>&1; then
              echo "Postgres is ready."
              exit 0
            fi
            echo "Postgres not ready ($i/120) ..."
            sleep 2
          done
          echo "Postgres never became ready."
          docker compose ps
          docker compose logs --no-color --tail=400 db || true
          exit 1

      # ---------------------------------------------------------------------
      # Create role ontop 
      # ---------------------------------------------------------------------
      - name: Create role ontop (no separate OMERO DB assumed)
        run: |
          set -euo pipefail
          cd .omero

          echo "Databases right now:"
          docker compose exec -T db psql -U postgres -d postgres -c "\l"

          docker compose exec -T db psql -U postgres -d postgres -c \
            "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'ontop') THEN CREATE ROLE ontop LOGIN PASSWORD '!ontop$'; END IF; END \$\$;"

          docker compose exec -T db psql -U postgres -d postgres -c "\du ontop" || true

      # ---------------------------------------------------------------------
      # Wait for OMERO 
      # ---------------------------------------------------------------------
      - name: Wait for OMERO schema marker public.dbpatch in DB 'postgres'
        run: |
          set -euo pipefail
          cd .omero
          echo "Waiting for OMERO schema in DB '${OMERO_DB}'..."

          for i in $(seq 1 300); do
            if docker compose exec -T db \
              psql -U postgres -d "${OMERO_DB}" -tAc "SELECT to_regclass('public.dbpatch');" \
              | grep -q "dbpatch"; then
              echo "OK: public.dbpatch exists (OMERO schema is ready)."
              exit 0
            fi

            echo "OMERO schema not ready yet ($i/300). Tail OMERO logs:"
            docker compose logs --no-color --tail=60 omero || true
            sleep 5
          done

          echo "ERROR: OMERO schema marker never appeared."
          docker compose logs --no-color --tail=400 omero || true
          docker compose logs --no-color --tail=250 db || true
          exit 1

      # ---------------------------------------------------------------------
      # Apply DB grants on the DB that actually contains OMERO tables
      # ---------------------------------------------------------------------
      - name: Grant ontop read access on OMERO DB (postgres)
        run: |
          set -euo pipefail
          cd .omero

          echo "Granting privileges for ontop on DB=${OMERO_DB} ..."

          docker compose exec -T db psql -U postgres -d postgres -c \
            "GRANT CONNECT ON DATABASE ${OMERO_DB} TO ontop;"

          docker compose exec -T db psql -U postgres -d "${OMERO_DB}" -c \
            "GRANT USAGE ON SCHEMA public TO ontop;"

          docker compose exec -T db psql -U postgres -d "${OMERO_DB}" -c \
            "GRANT SELECT ON ALL TABLES IN SCHEMA public TO ontop;"

          docker compose exec -T db psql -U postgres -d "${OMERO_DB}" -c \
            "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO ontop;"

          echo "Sanity check: ontop can read dbpatch:"
          docker compose exec -T db psql -U ontop -d "${OMERO_DB}" -tAc \
            "SELECT COUNT(*) FROM public.dbpatch;" || true

      # ---------------------------------------------------------------------
      # Python: 3.10 + prebuilt Ice wheel 
      # ---------------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps + OMERO CLI (prebuilt zeroc-ice wheel)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install \
            https://github.com/glencoesoftware/zeroc-ice-py-linux-x86_64/releases/download/20240202/zeroc_ice-3.6.5-cp310-cp310-manylinux_2_28_x86_64.whl
          python -m pip install "omero-py==5.21.2" pytest rdflib pandas requests

          which omero
          omero version

      # ---------------------------------------------------------------------
      # Verify repo mount inside OMERO container
      # ---------------------------------------------------------------------
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Verify repo mount inside OMERO container
        run: |
          set -euo pipefail
          cd .omero
          docker compose exec -T omero sh -lc "ls -la /repo && ls -la /repo/img | head -n 30"

      # ---------------------------------------------------------------------
      # Populate OMERO INSIDE the container 
      # ---------------------------------------------------------------------
      - name: Populate OMERO (CI script)
        run: |
          set -euo pipefail
          chmod +x utils/insert_data_WORKFLOW.sh
          ./utils/insert_data_WORKFLOW.sh

      # ---------------------------------------------------------------------
      # Populate HCS  INSIDE the OMERO container
      # ---------------------------------------------------------------------
      - name: Populate OMERO HCS dataset (inside container)
        run: |
          set -euo pipefail

          docker compose -f .omero/docker-compose.yml exec -T omero bash -lc '
            set -euo pipefail
            OMERO=/opt/omero/server/OMERO.server/bin/omero
            
            # login (inside container uses internal port)
            "$OMERO" login -C -u root -w omero -s localhost:4064

            Screen=$("$OMERO" obj new Screen name="IDR0017-Screen")
            echo "Created Screen: $Screen"

            "$OMERO" import /repo/img/idr0017/idr0017.xdce -T "$Screen"
          '

    
      # ---------------------------------------------------------------------
      # Ontop + pytest
      # ---------------------------------------------------------------------
      - name: Install ontop-cli
        run: |
          set -euo pipefail
          chmod +x utils/install_ontop.sh
          utils/install_ontop.sh

      - name: Debug confirm Postgres port open on runner
        run: |
          set -euo pipefail
          echo "Checking Postgres ${PGHOST}:${PGPORT} ..."
          (echo >/dev/tcp/${PGHOST}/${PGPORT}) >/dev/null 2>&1 && echo "PG port open" || (echo "PG port NOT open" && exit 1)

      - name: Run pytest
        run: |
          set -euo pipefail
          pytest -q

      # ---------------------------------------------------------------------
      # Teardown always
      # ---------------------------------------------------------------------
      - name: Teardown docker (always)
        if: always()
        run: |
          set -euo pipefail
          if [ -d .omero ]; then
            cd .omero
            docker compose ps || true
            docker compose logs --no-color --tail=300 omero || true
            docker compose logs --no-color --tail=200 db || true
            docker compose down -v || true
          fi

